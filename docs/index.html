<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>进食障碍眼动程序</title>

  <!-- 引入 Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <!-- jsPsych 相关脚本 -->
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-webgazer-init-camera@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-webgazer-calibrate@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-webgazer-validate@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/gh/jspsych/jspsych@jspsych@7.0.0/examples/js/webgazer/webgazer.js"></script>
  <script src="https://unpkg.com/@jspsych/extension-webgazer@1.0.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@1.0.0"></script>

  <style>
    /* 保持原有样式不变 */
    /* ==== 全局样式 ==== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      font-family: 'Roboto', 'Microsoft YaHei', sans-serif;
      background: #f5f6f8;
      color: #333;
      overflow: hidden;
    }

    /* ==== 顶部导航栏 ==== */
    .header {
      width: 100%;
      background: linear-gradient(90deg, #2c3e50, #4b6082);
      padding: 15px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      display: flex;
      justify-content: center;
    }
    .header h1 {
      color: #fff;
      font-weight: 500;
      font-size: 1.6rem;
      letter-spacing: 1px;
    }

    /* ==== 内容容器 ==== */
    #jspsych-target {
      position: absolute;
      top: 70px;
      left: 0;
      width: 100%;
      height: calc(100vh - 70px);
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f6f8;
    }
    #jspsych-target .jspsych-display-element {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f6f8;
    }
    #jspsych-target .jspsych-content {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      max-height: 100%;
    }

    /* ==== 图片展示区 ==== */
    .stimulus-container {
      width: 80%;
      max-width: 1000px;
      height: 70vh;
      margin: 0 auto;
      padding: 20px;
      border-radius: 20px;
      background: #ffffff;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stimulus-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 10px;
    }

    /* ==== 中央固定十字 ==== */
    .central-fixation {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 80px;
      color: #555;
      -webkit-user-select: none;
      user-select: none;
      z-index: 999;
      display: none;
    }

    /* ==== 眼动追踪注视点（已禁用） ==== */
    .gaze-point {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: red;
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      display: none !important; /* 确保小红点被隐藏 */
    }

    /* ==== 按钮样式 ==== */
    button {
      background: linear-gradient(90deg, #2980b9, #3498db);
      border: none;
      color: #fff;
      padding: 14px 36px;
      text-align: center;
      font-size: 1rem;
      margin: 6px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    button:hover {
      background: linear-gradient(90deg, #2572a5, #2c82c2);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    .jspsych-html-button-response .jspsych-button-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* ==== 居中文字模块 ==== */
    .centered-text {
      text-align: center;
      padding: 20px 30px;
      color: #444;
      line-height: 1.6;
      max-width: 800px;
    }
    .centered-text p {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    /* ==== 页脚 ==== */
    .footer {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: #888;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }

    /* ==== 登录表单样式 ==== */
    .login-container {
      width: 700px;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
      text-align: center;
      margin: 0 auto;
    }
    .login-container h2 {
      color: #2c3e50;
      margin-bottom: 25px;
      font-weight: 500;
    }
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    .form-group input:focus, .form-group select:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    .login-button {
      background: linear-gradient(90deg, #2980b9, #3498db);
      border: none;
      color: #fff;
      padding: 14px 36px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .login-button:hover {
      background: linear-gradient(90deg, #2572a5, #2c82c2);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    /* 新增：实验次数显示样式 */
    .session-display {
      background: #f0f7ff;
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
      border: 2px solid #d0e4ff;
      font-size: 1.3rem;
      font-weight: 500;
    }
    .session-display span {
      color: #2980b9;
      font-weight: 600;
    }

    /* ==== 数据报告样式 ==== */
    .data-report {
      max-width: 800px;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
      text-align: left;
      font-family: 'Courier New', monospace;
      max-height: 80vh;
      overflow-y: auto;
    }
    .data-report h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }
    .data-report pre {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .copy-button {
      background: linear-gradient(90deg, #27ae60, #2ecc71);
      border: none;
      color: #fff;
      padding: 12px 28px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .copy-button:hover {
      background: linear-gradient(90deg, #219653, #27ad60);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }
    .github-button {
      background: linear-gradient(90deg, #24292e, #2d3338);
      border: none;
      color: #fff;
      padding: 12px 28px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .github-button:hover {
      background: linear-gradient(90deg, #1a1e21, #22272b);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }
    /* 新增：保存按钮样式 */
    .save-button {
      background: linear-gradient(90deg, #f39c12, #e67e22);
      border: none;
      color: #fff;
      padding: 12px 28px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .save-button:hover {
      background: linear-gradient(90deg, #d35400, #e67e22);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    /* 退出按钮 */
    .exit-button {
      background: linear-gradient(90deg, #e74c3c, #c0392b);
      border: none;
      color: #fff;
      padding: 12px 28px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .exit-button:hover {
      background: linear-gradient(90deg, #c0392b, #a93226);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    /* ==== 状态消息 ==== */
    .status-message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-loading {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #b8daff;
    }
    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }

    /* 验证码弹窗 */
    .auth-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }
    .auth-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 15px 30px rgba(0,0,0,0.3);
    }
    .auth-content h3 {
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .auth-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    .auth-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .auth-button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
    }
    .auth-confirm {
      background: #27ae60;
      color: white;
    }
    .auth-confirm:hover {
      background: #219653;
    }
    .auth-cancel {
      background: #e74c3c;
      color: white;
    }
    .auth-cancel:hover {
      background: #c0392b;
    }
    .auth-error {
      color: #e74c3c;
      margin-top: 10px;
      display: none;
    }

    /* ==== 权限提示和错误提示样式 ==== */
    .permission-alert {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.3);
      text-align: center;
      z-index: 2000;
      max-width: 90%;
      width: 500px;
      display: none;
    }

    .permission-alert h3 {
      color: #e74c3c;
      margin-bottom: 20px;
    }

    .permission-alert p {
      margin: 10px 0;
      line-height: 1.6;
    }

    .permission-alert .warning {
      color: #e74c3c;
      font-weight: bold;
    }

    .permission-alert .browser-warning {
      background: #f8d7da;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }

    .permission-alert .protocol-warning {
      background: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }

    /* ==== 初始化状态面板 ==== */
    .init-status-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 15px;
      border-radius: 8px;
      max-width: 400px;
      z-index: 2000;
      font-size: 14px;
      display: none;
    }

    .init-status-panel h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #3498db;
      border-bottom: 1px solid #3498db;
      padding-bottom: 5px;
    }

    .init-status-panel .status-item {
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }

    .init-status-panel .status-label {
      font-weight: bold;
      margin-right: 10px;
    }

    .init-status-panel .status-value {
      color: #2ecc71;
    }

    .init-status-panel .status-error {
      color: #e74c3c;
    }

    .init-status-panel .status-warning {
      color: #f39c12;
    }

    .debug-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 2001;
    }

    /* ==== 错误处理面板 ==== */
    .error-panel {
      background: #f8d7da;
      border-left: 4px solid #e74c3c;
      padding: 15px;
      margin: 20px 0;
      border-radius: 0 8px 8px 0;
      text-align: left;
    }

    .error-panel h4 {
      color: #721c24;
      margin-top: 0;
      margin-bottom: 10px;
    }

    .error-panel ul {
      padding-left: 20px;
      margin-bottom: 10px;
    }

    .error-panel li {
      margin-bottom: 5px;
    }

    /* 结果表格样式 */
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    
    .results-table th, .results-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }
    
    .results-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    
    .results-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .results-table tr:hover {
      background-color: #f1f1f1;
    }
  </style>
</head>

<body>
  <!-- 顶部导航栏 -->
  <div class="header">
    <h1>进食障碍眼动程序</h1>
  </div>

  <!-- 中央固定十字 -->
  <div id="central-fixation" class="central-fixation">+</div>

  <!-- 眼动追踪注视点（已禁用） -->
  <div id="gaze-point" class="gaze-point"></div>

  <!-- 验证码弹窗 -->
  <div class="auth-modal" id="auth-modal">
    <div class="auth-content">
      <h3>请输入验证码以查看GitHub记录</h3>
      <input type="text" class="auth-input" id="auth-code" placeholder="输入验证码" />
      <div class="auth-error" id="auth-error">验证码错误，无权限查看</div>
      <div class="auth-buttons">
        <button class="auth-button auth-cancel" id="auth-cancel">返回</button>
        <button class="auth-button auth-confirm" id="auth-confirm">确认</button>
      </div>
    </div>
  </div>

  <!-- 摄像头权限提示 -->
  <div id="camera-permission-alert" class="permission-alert" style="display:none;"></div>

  <!-- 初始化状态面板 -->
  <div class="init-status-panel" id="init-status-panel">
    <h4>眼动追踪初始化状态</h4>
    <div class="status-item">
      <span class="status-label">摄像头状态:</span>
      <span class="status-value" id="status-camera">检测中...</span>
    </div>
    <div class="status-item">
      <span class="status-label">Webgazer状态:</span>
      <span class="status-value" id="status-webgazer">未初始化</span>
    </div>
    <div class="status-item">
      <span class="status-label">权限状态:</span>
      <span class="status-value" id="status-permission">未知</span>
    </div>
    <div class="status-item">
      <span class="status-label">安全环境:</span>
      <span class="status-value" id="status-security">检测中...</span>
    </div>
    <div class="status-item">
      <span class="status-label">错误信息:</span>
      <span class="status-value" id="status-error">无</span>
    </div>
  </div>

  <button class="debug-toggle" id="debug-toggle">显示调试信息</button>

  <!-- jsPsych 渲染目标容器 -->
  <div id="jspsych-target"></div>

  <!-- 页脚 -->
  <div class="footer">2025 北京师范大学 Eye—ED 项目组联合出品。</div>

  <script>
    /* ==== 用户信息存储 ==== */
    let userInfo = null;
    let cameraPermissionDenied = false; // 摄像头权限状态
    let webgazerInitialized = false;   // Webgazer初始化状态
    let gazeData = []; // 存储每个试次的眼动数据
    
    // 新增：实验结果数据存储
    let experimentResults = {
      f: {
        gazeTimes: [],       // 每个试次的高热量-低热量注视时间
        firstFixations: [],  // 每个试次的高热量首视点-低热量首视点
        revisits: []         // 每个试次的回视次数
      },
      b: {
        gazeTimes: [],       // 每个试次的胖子-瘦子注视时间
        firstFixations: [],  // 每个试次的胖子首视点-瘦子首视点
        revisits: []         // 每个试次的回视次数
      }
    };

    let currentTrialData = []; // 当前试次的眼动数据
    let trialStartTime = 0;    // 当前试次开始时间
    let gazeUpdateInterval;    // 眼动数据更新间隔

    /* ==== GitHub API 中转配置 ==== */
    const API_BASE_URL = 'https://ok.edemi-lab.online/api/gh-eye';

    /* 初始化 jsPsych */
    const jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      extensions: [
        {
          type: jsPsychExtensionWebgazer,
          params: {
            capture_events: ['gaze'], // 捕获眼动事件
            sampling_rate: 50 // 每秒采样50次
          }
        }
      ],
      on_trial_start: function(trial) {
        // 开始记录当前试次的眼动数据
        if (trial.type === jsPsychImageKeyboardResponse && trial.data && trial.data.category) {
          currentTrialData = [];
          trialStartTime = performance.now();
          
          // 开始收集眼动数据
          if (!cameraPermissionDenied && webgazerInitialized) {
            gazeUpdateInterval = setInterval(() => {
              const gaze = webgazer.getCurrentPrediction();
              if (gaze) {
                currentTrialData.push({
                  x: gaze.x,
                  y: gaze.y,
                  time: performance.now() - trialStartTime
                });
              }
            }, 20); // 每20ms采集一次，对应50Hz采样率
          }
        }
      },
      on_trial_finish: function(data) {
        // 停止收集当前试次的眼动数据
        clearInterval(gazeUpdateInterval);
        
        // 处理当前试次的数据
        if (data.category && currentTrialData.length > 0) {
          processTrialData(data.category, currentTrialData);
        }
      },
      on_finish: function() {
        // 实验结束时计算并显示结果
        showResults();
      }
    });

    /* ==== 数据处理函数 ==== */
    
    // 判断注视点在左侧还是右侧
    function isLeftRegion(x) {
      // 假设屏幕宽度的一半为界限
      const screenWidth = window.innerWidth;
      return x < screenWidth / 2;
    }
    
    // 处理单个试次的数据
    function processTrialData(category, data) {
      if (data.length === 0) return;
      
      // 区分食物(F)和身体(B)类别的处理逻辑
      if (category === 'food') {
        processFoodTrial(data);
      } else if (category === 'body') {
        processBodyTrial(data);
      }
    }
    
    // 处理食物类试次数据
    function processFoodTrial(data) {
      let highCalorieTime = 0; // 高热量区域(右侧)注视时间
      let lowCalorieTime = 0;  // 低热量区域(左侧)注视时间
      let firstFixationHigh = 0; // 首视点在高热量区域
      let firstFixationLow = 0;  // 首视点在低热量区域
      let revisitCount = 0;      // 回视次数
      
      // 采样间隔为20ms，计算每个点的持续时间
      const sampleInterval = 20;
      
      // 首视点判断
      const firstGaze = data[0];
      if (isLeftRegion(firstGaze.x)) {
        firstFixationLow = 1;
      } else {
        firstFixationHigh = 1;
      }
      
      // 注视时间计算和回视模式检测
      let previousRegion = null;
      let regionSequence = [];
      
      data.forEach(point => {
        const currentRegion = isLeftRegion(point.x) ? 'low' : 'high';
        
        // 累加注视时间
        if (currentRegion === 'high') {
          highCalorieTime += sampleInterval;
        } else {
          lowCalorieTime += sampleInterval;
        }
        
        // 记录区域序列用于回视检测
        if (currentRegion !== previousRegion) {
          regionSequence.push(currentRegion);
          previousRegion = currentRegion;
        }
      });
      
      // 检测回视模式: high → low → high
      for (let i = 0; i < regionSequence.length - 2; i++) {
        if (regionSequence[i] === 'high' && 
            regionSequence[i+1] === 'low' && 
            regionSequence[i+2] === 'high') {
          revisitCount++;
        }
      }
      
      // 保存结果
      experimentResults.f.gazeTimes.push(highCalorieTime - lowCalorieTime);
      experimentResults.f.firstFixations.push(firstFixationHigh - firstFixationLow);
      experimentResults.f.revisits.push(revisitCount);
    }
    
    // 处理身体类试次数据
    function processBodyTrial(data) {
      let fatTime = 0;     // 胖子区域(左侧)注视时间
      let thinTime = 0;    // 瘦子区域(右侧)注视时间
      let firstFixationFat = 0;  // 首视点在胖子区域
      let firstFixationThin = 0; // 首视点在瘦子区域
      let revisitCount = 0;      // 回视次数
      
      // 采样间隔为20ms，计算每个点的持续时间
      const sampleInterval = 20;
      
      // 首视点判断
      const firstGaze = data[0];
      if (isLeftRegion(firstGaze.x)) {
        firstFixationFat = 1;
      } else {
        firstFixationThin = 1;
      }
      
      // 注视时间计算和回视模式检测
      let previousRegion = null;
      let regionSequence = [];
      
      data.forEach(point => {
        const currentRegion = isLeftRegion(point.x) ? 'fat' : 'thin';
        
        // 累加注视时间
        if (currentRegion === 'fat') {
          fatTime += sampleInterval;
        } else {
          thinTime += sampleInterval;
        }
        
        // 记录区域序列用于回视检测
        if (currentRegion !== previousRegion) {
          regionSequence.push(currentRegion);
          previousRegion = currentRegion;
        }
      });
      
      // 检测回视模式: fat → thin → fat
      for (let i = 0; i < regionSequence.length - 2; i++) {
        if (regionSequence[i] === 'fat' && 
            regionSequence[i+1] === 'thin' && 
            regionSequence[i+2] === 'fat') {
          revisitCount++;
        }
      }
      
      // 保存结果
      experimentResults.b.gazeTimes.push(fatTime - thinTime);
      experimentResults.b.firstFixations.push(firstFixationFat - firstFixationThin);
      experimentResults.b.revisits.push(revisitCount);
    }
    
    // 计算平均值
    function calculateAverage(arr) {
      if (arr.length === 0) return 0;
      const sum = arr.reduce((a, b) => a + b, 0);
      return (sum / arr.length).toFixed(2);
    }
    
    // 显示实验结果
    function showResults() {
      // 计算各类平均值
      const fGazeTimeAvg = calculateAverage(experimentResults.f.gazeTimes);
      const fFirstFixAvg = calculateAverage(experimentResults.f.firstFixations);
      const fRevisitAvg = calculateAverage(experimentResults.f.revisits);
      
      const bGazeTimeAvg = calculateAverage(experimentResults.b.gazeTimes);
      const bFirstFixAvg = calculateAverage(experimentResults.b.firstFixations);
      const bRevisitAvg = calculateAverage(experimentResults.b.revisits);
      
      // 创建结果表格
      const resultsHTML = `
        <div class="data-report">
          <h2>实验结果</h2>
          <table class="results-table">
            <tr>
              <th>被试编号</th>
              <th>F注视时间(ms)</th>
              <th>F首视点</th>
              <th>F回视次数</th>
              <th>B注视时间(ms)</th>
              <th>B首视点</th>
              <th>B回视次数</th>
            </tr>
            <tr>
              <td>${userInfo.subjectId}</td>
              <td>${fGazeTimeAvg}</td>
              <td>${fFirstFixAvg}</td>
              <td>${fRevisitAvg}</td>
              <td>${bGazeTimeAvg}</td>
              <td>${bFirstFixAvg}</td>
              <td>${bRevisitAvg}</td>
            </tr>
          </table>
          
          <div style="text-align: center; margin-top: 30px;">
            <button class="save-button" id="save-results">保存结果</button>
            <button class="github-button" id="upload-results">上传到GitHub</button>
          </div>
        </div>
      `;
      
      // 显示结果
      jsPsych.getDisplayElement().innerHTML = resultsHTML;
      
      // 添加保存和上传事件
      document.getElementById('save-results').addEventListener('click', function() {
        saveResultsToCSV(fGazeTimeAvg, fFirstFixAvg, fRevisitAvg, 
                        bGazeTimeAvg, bFirstFixAvg, bRevisitAvg);
      });
      
      document.getElementById('upload-results').addEventListener('click', function() {
        uploadResultsToGitHub(fGazeTimeAvg, fFirstFixAvg, fRevisitAvg, 
                            bGazeTimeAvg, bFirstFixAvg, bRevisitAvg);
      });
    }
    
    // 保存结果到CSV
    function saveResultsToCSV(fGaze, fFirst, fRevisit, bGaze, bFirst, bRevisit) {
      const now = new Date();
      const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`;
      const fileName = `${userInfo.subjectId}_results_${dateStr}.csv`;
      
      const csvContent = `被试编号,F注视时间(ms),F首视点,F回视次数,B注视时间(ms),B首视点,B回视次数\n` +
                        `${userInfo.subjectId},${fGaze},${fFirst},${fRevisit},${bGaze},${bFirst},${bRevisit}`;
      
      saveCSVToLocal(csvContent, fileName);
    }
    
    // 上传结果到GitHub
    async function uploadResultsToGitHub(fGaze, fFirst, fRevisit, bGaze, bFirst, bRevisit) {
      try {
        const issue = await getOrCreateIssue();
        const issueNumber = issue.number;
        
        const comment = `## 实验结果\n\n` +
                       `| 指标 | 数值 |\n` +
                       `|------|------|\n` +
                       `| 被试编号 | ${userInfo.subjectId} |\n` +
                       `| F注视时间(ms) | ${fGaze} |\n` +
                       `| F首视点 | ${fFirst} |\n` +
                       `| F回视次数 | ${fRevisit} |\n` +
                       `| B注视时间(ms) | ${bGaze} |\n` +
                       `| B首视点 | ${bFirst} |\n` +
                       `| B回视次数 | ${bRevisit} |\n`;
        
        await addIssueComment(issueNumber, comment);
        
        // 显示成功消息
        alert('结果已成功上传到GitHub');
      } catch (error) {
        console.error('上传结果失败:', error);
        alert(`上传失败: ${error.message}`);
      }
    }

    /* ==== 状态更新函数 ==== */
    function updateInitStatus(field, value, isError = false) {
      const element = document.getElementById(`status-${field}`);
      if (element) {
        element.textContent = value;
        element.className = isError ? 'status-error' : 'status-value';
      }
    }

    // 显示/隐藏调试信息
    document.getElementById('debug-toggle').addEventListener('click', function() {
      const panel = document.getElementById('init-status-panel');
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        this.textContent = '显示调试信息';
      } else {
        panel.style.display = 'block';
        this.textContent = '隐藏调试信息';
      }
    });

    /* ==== 摄像头权限检测和错误处理函数 ==== */
    async function checkCameraPermission() {
      // 更新状态
      updateInitStatus('camera', '检测中...');
      updateInitStatus('permission', '检测中...');
      updateInitStatus('security', '检测中...');

      // 1. 检查是否在安全环境（HTTPS或localhost）
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
      updateInitStatus('security', isSecure ? '安全' : '不安全', !isSecure);

      // 2. 检查浏览器是否支持媒体设备
      const hasMediaDevices = 'mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices;
      updateInitStatus('camera', hasMediaDevices ? '支持' : '不支持', !hasMediaDevices);

      // 3. 尝试获取摄像头权限
      let hasPermission = false;
      try {
        if (hasMediaDevices) {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          hasPermission = true;
          // 关闭测试流
          stream.getTracks().forEach(track => track.stop());
        }
      } catch (error) {
        console.error('摄像头权限检测失败:', error);
        updateInitStatus('error', error.message || error.toString(), true);
      }

      updateInitStatus('permission', hasPermission ? '已授予' : '未授予', !hasPermission);

      return {
        hasPermission,
        isSecure,
        hasMediaDevices
      };
    }

    function showPermissionError(status) {
      const alertEl = document.getElementById('camera-permission-alert');

      let alertHTML = `
        <h3>摄像头权限问题</h3>
        ${!status.hasMediaDevices ? `
          <div class="browser-warning">
            <p class="warning">您的浏览器不支持摄像头功能</p>
            <p>请使用最新版本的Chrome、Firefox或Edge浏览器参与实验。</p>
          </div>
        ` : ''}

        ${!status.isSecure ? `
          <div class="protocol-warning">
            <p class="warning">当前环境不安全</p>
            <p>摄像头功能需要HTTPS安全连接或本地环境(localhost)。</p>
            <p>当前协议: ${location.protocol}</p>
          </div>
        ` : ''}

        ${status.hasMediaDevices && status.isSecure && !status.hasPermission ? `
          <p>实验需要使用您的摄像头进行眼动追踪。</p>
          <p>您尚未授予摄像头权限或权限已被拒绝。</p>
          <div class="instructions">
            <p class="warning">请按照以下步骤操作：</p>
            <ol>
              <li>点击浏览器地址栏左侧的摄像头图标</li>
              <li>选择"始终允许此网站使用摄像头"</li>
              <li>刷新页面</li>
            </ol>
          </div>
        ` : ''}

        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
          <button id="reload-btn" class="auth-confirm auth-button">刷新页面</button>
          <button id="continue-btn" class="auth-cancel auth-button">继续实验(无眼动)</button>
        </div>
      `;

      alertEl.innerHTML = alertHTML;
      alertEl.style.display = 'block';

      // 添加事件处理
      document.getElementById('reload-btn').addEventListener('click', () => {
        location.reload();
      });

      document.getElementById('continue-btn').addEventListener('click', function() {
        alertEl.style.display = 'none';
        // 设置标志允许实验继续（无眼动功能）
        cameraPermissionDenied = true;
        // 继续执行实验流程
        if (window.resumeExperiment) {
          window.resumeExperiment();
        }
      });
    }

    /* ==== GitHub API 功能 ==== */

    // 创建或获取Issue（带错误处理和重试机制） - 总共尝试2次
    async function getOrCreateIssue(retries = 1) {
      const issueTitle = `${userInfo.subjectId}`;

      try {
        // 使用AbortController实现超时
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'create_issue',
            subjectId: userInfo.subjectId,
            gender: userInfo.gender,
            age: userInfo.age
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorData = await response.json();
          console.error('GitHub API错误详情:', errorData);
          let errorMsg = `中转API返回错误: ${response.status}`;
          if (errorData && errorData.error) {
            errorMsg = errorData.error;
            if (errorData.message) {
              errorMsg += `: ${errorData.message}`;
            }
          }
          throw new Error(errorMsg);
        }

        return await response.json();
      } catch (error) {
        console.error(`GitHub Issue操作失败(剩余重试次数: ${retries-1}):`, error);

        // 如果还有重试次数，等待后重试
        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return getOrCreateIssue(retries - 1);
        }

        throw error;
      }
    }

    // 添加单条Issue评论 - 修改：重试次数改为1（即总共尝试2次）
    async function addIssueComment(issueNumber, commentBody, retries = 1) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'add_comment',
            issueNumber: issueNumber,
            commentBody: commentBody
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorData = await response.json();
          console.error('添加评论错误详情:', errorData);
          let errorMsg = `中转API返回错误: ${response.status}`;
          if (errorData && errorData.error) {
            errorMsg = errorData.error;
            if (errorData.message) {
              errorMsg += `: ${errorData.message}`;
            }
          }
          throw new Error(errorMsg);
        }

        return await response.json();
      } catch (error) {
        console.error(`添加评论失败(剩余重试次数: ${retries-1}):`, error);

        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return addIssueComment(issueNumber, commentBody, retries - 1);
        }

        throw error;
      }
    }

    // 上传文件到GitHub仓库（支持分块上传）
    async function uploadFileToGitHub(content, fileName, directory, retries = 1) {
      const MAX_FILE_SIZE = 700 * 1024; // 700KB
      const encoder = new TextEncoder();
      const fileData = encoder.encode(content);
      const totalSize = fileData.length;

      try {
        // 解析文件名和后缀
        const lastDotIndex = fileName.lastIndexOf('.');
        let baseName, extension;
        if (lastDotIndex === -1) {
          baseName = fileName;
          extension = '';
        } else {
          baseName = fileName.substring(0, lastDotIndex);
          extension = fileName.substring(lastDotIndex + 1);
        }

        // 如果文件小于最大限制，直接上传
        if (totalSize <= MAX_FILE_SIZE) {
          return await uploadFilePart(content, `${directory}/${fileName}`, retries);
        }

        // 分割文件
        let uploadPromises = [];
        let partIndex = 1;
        let startIndex = 0;

        while (startIndex < totalSize) {
          // 计算结束位置（尝试在换行符处分割）
          let endIndex = Math.min(startIndex + MAX_FILE_SIZE, totalSize);

          // 查找最近的换行符
          while (endIndex < totalSize && fileData[endIndex] !== 10) { // 10是换行符的ASCII
            endIndex++;
          }

          // 如果找不到换行符，使用最大位置
          if (endIndex >= totalSize) {
            endIndex = totalSize;
          }

          // 提取当前部分
          const partData = fileData.slice(startIndex, endIndex);
          const partContent = new TextDecoder().decode(partData);

          // 生成文件名（添加分块编号）
          const newFileName = extension ? `${baseName}_part${partIndex}.${extension}` : `${baseName}_part${partIndex}`;
          const partFileName = `${directory}/${newFileName}`;

          // 上传分块
          uploadPromises.push(uploadFilePart(partContent, partFileName, retries));

          // 移动到下一部分
          startIndex = endIndex;
          partIndex++;
        }

        // 等待所有上传完成
        return await Promise.all(uploadPromises);
      } catch (error) {
        console.error(`文件上传失败(剩余重试次数: ${retries-1}):`, error);

        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return uploadFileToGitHub(content, fileName, directory, retries - 1);
        }

        throw error;
      }
    }

    // 上传单个文件分块到GitHub - 总共尝试2次
    async function uploadFilePart(content, fileName, retries = 1) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000); // 延长超时时间到20秒

        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'upload_file',
            fileName: fileName,
            content: content,
            directory: fileName.includes('/') ? fileName.substring(0, fileName.lastIndexOf('/')) : ''
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          // 尝试解析错误信息
          let errorMsg = `文件上传失败: ${response.status}`;
          try {
            const errorData = await response.json();
            if (errorData && errorData.error) {
              errorMsg = errorData.error;
              if (errorData.message) {
                errorMsg += `: ${errorData.message}`;
              }
            }
          } catch (e) {
            // 如果解析失败，保持原错误信息
            console.error('解析错误响应失败', e);
          }
          throw new Error(errorMsg);
        }

        return await response.json();
      } catch (error) {
        console.error(`文件分块上传失败(剩余重试次数: ${retries-1}):`, error);

        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return uploadFilePart(content, fileName, retries - 1);
        }

        throw error;
      }
    }

    // 生成GitHub评论内容（只包含数据点个数和实验时间）
    function generateGitHubComment(dataPoints) {
      // 获取当前日期时间
      const now = new Date();
      const dateTime = `${now.getFullYear()}年${(now.getMonth()+1).toString().padStart(2, '0')}月${now.getDate().toString().padStart(2, '0')}日 ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

      return `## 第 ${userInfo.session} 次实验数据\n\n` +
             `- **实验日期时间**: ${dateTime}\n` +
             `- **眼动数据点总数**: ${dataPoints}\n`;
    }

    // 保存CSV到本地
    function saveCSVToLocal(csvContent, fileName) {
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // 保存JSON到本地
    function saveJSONToLocal(jsonContent, fileName) {
      const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    /* 生成图片列表 */
    // 食物图片：f文件夹（共20张）
    // 前8张：左侧低热量；后12张：左侧高热量
    const foodImages = [];
    const totalFood = 20;
    const lowCalorieCount = 8; // 前8张为左侧低热量
    for (let i = 1; i <= totalFood; i++) {
      const isLowCalorie = i <= lowCalorieCount;
      foodImages.push({
        src: `f/${i}.jpg`, // 图片路径：f文件夹下
        type: 'food',
        attribute: isLowCalorie ? 'low_calorie' : 'high_calorie', // 标记高低热量
        position: 'left', // 左侧为目标属性（低/高热量）
        index: i // 原始序号
      });
    }

    // 身材图片：b文件夹（共25张）
    // 前11张：左侧胖；后14张：左侧瘦
    const bodyImages = [];
    const totalBody = 25;
    const fatCount = 11; // 前11张为左侧胖
    for (let i = 1; i <= totalBody; i++) {
      const isFat = i <= fatCount;
      bodyImages.push({
        src: `b/${i}.jpg`, // 图片路径：b文件夹下
        type: 'body',
        attribute: isFat ? 'fat' : 'thin', // 标记胖/瘦
        position: 'left', // 左侧为目标属性（胖/瘦）
        index: i // 原始序号
      });
    }

    /* ==== 中间眼动校准环节 ==== */
    const midCalibrationTrial = {
      type: jsPsychWebgazerCalibrate,
      calibration_points: [
        [25, 25],   // 左上角
        [75, 25],   // 右上角
        [50, 50],   // 中心
        [25, 75],   // 左下角
        [75, 75]    // 右下角
      ],
      calibration_mode: 'click',
      repetitions_per_point: 1,
      time_to_saccade: 1000,
      show_validation: true,
      on_load: function() {
        updateInitStatus('webgazer', '中间校准中');
      },
      on_finish: function() {
        updateInitStatus('webgazer', '中间校准完成');
      }
    };

    const midCalibrationInstructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="centered-text">
          <p>接下来将进行眼动重新校准</p>
          <p>请注视屏幕上出现的点，并在点变色时点击它</p>
          <p>按空格键开始</p>
        </div>
      `,
      choices: [' ']
    };

    // 中间校准流程
    const midCalibrationProcedure = [
      midCalibrationInstructions,
      midCalibrationTrial
    ];

    /* ==== 实验试次生成函数 ==== */
    function createTrial(stimulus) {
      return {
        type: jsPsychImageKeyboardResponse,
        stimulus: stimulus.src,
        choices: "NO_KEYS",  // 不需要被试按键反应
        trial_duration: 6000, // 每个试次6秒
        data: {
          category: stimulus.type,
          attribute: stimulus.attribute,
          index: stimulus.index
        },
        extensions: cameraPermissionDenied ? [] : [
          {
            type: jsPsychExtensionWebgazer,
            params: {
              target: 'stimulus'
            }
          }
        ],
        on_load: function() {
          // 显示图片容器
          document.querySelector('.stimulus-container').style.display = 'flex';
        }
      };
    }

    // 创建注视点试次
    function createFixationTrial(duration = 1000) {
      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div class="central-fixation" style="display: block;">+</div>`,
        choices: "NO_KEYS",
        trial_duration: duration,
        on_load: function() {
          // 隐藏图片容器，显示注视点
          const container = document.querySelector('.stimulus-container');
          if (container) container.style.display = 'none';
          document.getElementById('central-fixation').style.display = 'block';
        },
        on_finish: function() {
          document.getElementById('central-fixation').style.display = 'none';
        }
      };
    }

    /* ==== 实验流程 ==== */
    const experimentTimeline = [];

    // 实验指导语
    const instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="centered-text">
          <p>欢迎参加本实验</p>
          <p>在实验过程中，屏幕上将呈现一系列图片</p>
          <p>请您自然地观看这些图片，无需做出任何反应</p>
          <p>实验过程中请保持头部稳定，尽量不要移动</p>
          <p>按空格键开始实验</p>
        </div>
      `,
      choices: [' ']
    };
    experimentTimeline.push(instructions);

    // 添加食物图片试次
    foodImages.forEach((image, index) => {
      // 在每个图片试次前添加注视点
      experimentTimeline.push(createFixationTrial());
      // 添加图片试次
      experimentTimeline.push(createTrial(image));
    });

    // 在食物和身体图片之间添加中间校准环节
    experimentTimeline.push(...midCalibrationProcedure);

    // 添加身体图片试次
    bodyImages.forEach((image, index) => {
      // 在每个图片试次前添加注视点
      experimentTimeline.push(createFixationTrial());
      // 添加图片试次
      experimentTimeline.push(createTrial(image));
    });

    /* ==== 用户登录页面 ==== */
    const loginScreen = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function() {
        // 获取当前被试的次数信息
        let sessionInfo = "";
        const subjectIdEl = document.getElementById('subject-id');
        if (subjectIdEl && subjectIdEl.value) {
          const subjectId = subjectIdEl.value;
          const storedSession = localStorage.getItem(`session_${subjectId}`);
          const currentSession = storedSession ? parseInt(storedSession) + 1 : 1;
          sessionInfo = `<div class="session-display">这是您的第 <span>${currentSession}</span> 次实验</div>`;
        }

        return `
          <div class="login-container">
            <h2>实验用户登录</h2>
            <div class="form-group">
              <label for="subject-id">被试ID</label>
              <select id="subject-id">
                <option value="">请选择被试ID</option>
                ${Array.from({length: 61}, (_, i) => {
                  const id = `eye-${(i+1).toString().padStart(3, '0')}`;
                  return `<option value="${id}">${id}</option>`;
                }).join('')}
              </select>
            </div>
            ${sessionInfo}
            <div class="form-group">
              <label for="gender">性别</label>
              <select id="gender">
                <option value="">请选择性别</option>
                <option value="男">男</option>
                <option value="女">女</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="form-group">
              <label for="age">年龄</label>
              <input type="number" id="age" min="18" max="60" placeholder="请输入年龄">
            </div>
            <button class="login-button" id="login-btn">开始实验</button>
            <div id="login-status" style="margin-top: 15px;"></div>
          </div>
        `;
      },
      choices: [],
      on_load: function() {
        // 监听被试ID变化，更新次数显示并自动填充用户信息
        document.getElementById('subject-id').addEventListener('change', function() {
          const subjectId = this.value;
          if (subjectId) {
            const storedSession = localStorage.getItem(`session_${subjectId}`);
            const currentSession = storedSession ? parseInt(storedSession) + 1 : 1;

            // 创建或更新次数显示
            let sessionDisplay = document.querySelector('.session-display');
            if (!sessionDisplay) {
              sessionDisplay = document.createElement('div');
              sessionDisplay.className = 'session-display';
              document.querySelector('.login-container').insertBefore(sessionDisplay, document.querySelector('.form-group:last-child'));
            }
            sessionDisplay.innerHTML = `这是您的第 <span>${currentSession}</span> 次实验`;

            // 尝试获取存储的用户信息并自动填充
            const userData = localStorage.getItem(`user_${subjectId}`);
            if (userData) {
              try {
                const { gender, age } = JSON.parse(userData);
                document.getElementById('gender').value = gender;
                document.getElementById('age').value = age;
              } catch (e) {
                console.error('解析用户信息失败', e);
              }
            }
          }
        });

        document.getElementById('login-btn').addEventListener('click', function() {
          const subjectId = document.getElementById('subject-id').value;
          const gender = document.getElementById('gender').value;
          const age = document.getElementById('age').value;
          const statusEl = document.getElementById('login-status');

          if (!subjectId) {
            statusEl.innerHTML = '<p style="color: #e74c3c;">请选择被试ID</p>';
            return;
          }
          if (!gender) {
            statusEl.innerHTML = '<p style="color: #e74c3c;">请选择性别</p>';
            return;
          }
          if (!age) {
            statusEl.innerHTML = '<p style="color: #e74c3c;">请输入年龄</p>';
            return;
          }

          // 从localStorage获取当前次数
          const storedSession = localStorage.getItem(`session_${subjectId}`);
          const session = storedSession ? parseInt(storedSession) + 1 : 1;

          // 保存用户信息
          userInfo = {
            subjectId,
            session,
            gender,
            age
          };

          // 保存到localStorage
          localStorage.setItem(`user_${subjectId}`, JSON.stringify({ gender, age }));
          localStorage.setItem(`session_${subjectId}`, session.toString());

          // 开始实验流程
          startExperiment();
        });
      }
    };

    /* ==== 实验开始函数 ==== */
    async function startExperiment() {
      // 检查摄像头权限
      const permissionStatus = await checkCameraPermission();
      
      if (!permissionStatus.hasPermission && permissionStatus.hasMediaDevices && permissionStatus.isSecure) {
        // 显示权限错误提示
        return new Promise(resolve => {
          window.resumeExperiment = resolve;
          showPermissionError(permissionStatus);
        });
      }

      // 初始化眼动追踪
      if (!cameraPermissionDenied) {
        const initCamera = {
          type: jsPsychWebgazerInitCamera,
          on_load: function() {
            updateInitStatus('webgazer', '初始化中');
          },
          on_finish: function() {
            webgazerInitialized = true;
            updateInitStatus('webgazer', '已初始化');
          }
        };

        const calibration = {
          type: jsPsychWebgazerCalibrate,
          calibration_points: [
            [25, 25],   // 左上角
            [75, 25],   // 右上角
            [50, 50],   // 中心
            [25, 75],   // 左下角
            [75, 75]    // 右下角
          ],
          calibration_mode: 'click',
          repetitions_per_point: 1,
          time_to_saccade: 1000,
          show_validation: true
        };

        const calibrationInstructions = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
            <div class="centered-text">
              <p>接下来将进行眼动校准</p>
              <p>请注视屏幕上出现的点，并在点变色时点击它</p>
              <p>这将帮助系统更准确地追踪您的视线</p>
              <p>按空格键开始校准</p>
            </div>
          `,
          choices: [' ']
        };

        // 先执行校准流程，再执行实验
        jsPsych.run([
          calibrationInstructions,
          initCamera,
          calibration,
          ...experimentTimeline
        ]);
      } else {
        // 如果没有摄像头权限，直接开始实验
        jsPsych.run(experimentTimeline);
      }
    }

    /* ==== 启动程序 ==== */
    jsPsych.run([loginScreen]);
  </script>
</body>
</html>
